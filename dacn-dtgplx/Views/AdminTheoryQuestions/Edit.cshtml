@using dacn_dtgplx.ViewModels
@model CauHoiEditVM

@{
    ViewData["Title"] = "Sửa câu hỏi";
}

<style>
    .qa-card {
        background: #ffffff;
        border-radius: 8px;
        padding: 15px;
        box-shadow: 0 0 10px rgba(0,0,0,0.1);
        margin-bottom: 20px;
    }

    .section-title {
        font-weight: 600;
        margin-bottom: 15px;
        color: #333;
    }

    .two-column-layout {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
    }

    .column-header {
        text-align: center;
        font-weight: 600;
        color: #0d6efd;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 2px solid #0d6efd;
    }

    .img-picker {
        position: relative;
        cursor: pointer;
        border-radius: 8px;
        overflow: hidden;
        border: 1px solid #ddd;
        background: #f8f9fa;
        min-height: 200px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

        .img-picker img {
            width: 100%;
            max-height: 250px;
            object-fit: contain;
        }

        .img-picker .overlay {
            position: absolute;
            inset: 0;
            background: rgba(0,0,0,0.45);
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: .2s;
            font-size: 32px;
        }

        .img-picker:hover .overlay {
            opacity: 1;
        }

    .answers-table {
        width: 100%;
        border-collapse: collapse;
    }

        .answers-table th {
            background: #f8f9fa;
            padding: 12px;
            text-align: center;
            border: 1px solid #dee2e6;
            font-weight: 600;
        }

        .answers-table td {
            padding: 12px;
            text-align: center;
            border: 1px solid #dee2e6;
            vertical-align: middle;
        }

    .answer-status {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 4px;
        font-size: 0.9rem;
        margin-left: 10px;
    }

    .status-correct {
        background: #d1fae5;
        color: #065f46;
    }

    .status-incorrect {
        background: #fee2e2;
        color: #991b1b;
    }

    @@media (max-width: 768px) {
        .two-column-layout

    {
        grid-template-columns: 1fr;
    }

    }
</style>

<h2 class="fw-bold mb-4 text-primary">Sửa câu hỏi @Model.IdCauHoi</h2>

<form asp-action="Edit" asp-controller="AdminTheoryQuestions"
      method="post" enctype="multipart/form-data">

    <input type="hidden" asp-for="IdCauHoi" />

    <!-- CHƯƠNG -->
    <div class="qa-card">
        <div class="section-title">Chương</div>
        <select class="form-select" asp-for="ChuongId">
            @foreach (var c in ViewBag.Chapters)
            {
                <option value="@c.ChuongId">@c.TenChuong</option>
            }
        </select>
    </div>

    <!-- THUỘC TÍNH -->
    <div class="qa-card">
        <div class="section-title">Thuộc tính</div>
        <div class="d-flex gap-3">
            <label class="form-check d-flex align-items-center gap-2">
                <input type="checkbox" asp-for="CauLiet" class="form-check-input" />
                <span style="font-size: 1.1rem;">Câu liệt</span>
            </label>

            <label class="form-check d-flex align-items-center gap-2">
                <input type="checkbox" asp-for="ChuY" class="form-check-input" />
                <span style="font-size: 1.1rem;">Chú ý</span>
            </label>

            <label class="form-check d-flex align-items-center gap-2">
                <input type="checkbox" asp-for="XeMay" class="form-check-input" />
                <span style="font-size: 1.1rem;">Xe máy</span>
            </label>
        </div>
    </div>

    <!-- NỘI DUNG -->
    <div class="qa-card">
        <div class="section-title">Nội dung câu hỏi</div>
        <textarea class="form-control" asp-for="NoiDung" rows="3"></textarea>
    </div>

    <!-- ẢNH 2 CỘT -->
    <div class="qa-card">
        <div class="two-column-layout">
            <!-- Cột trái -->
            <div>
                <div class="column-header">Câu hỏi</div>
                <div class="img-picker" onclick="document.getElementById('UploadHinhAnh').click()">
                    @{
                        string img1 = string.IsNullOrEmpty(Model.HinhAnh)
                        ? "/images/no-image.png"
                        : (Model.HinhAnh.StartsWith("/") ? Model.HinhAnh : "/" + Model.HinhAnh);
                    }
                    <img id="PreviewHinhAnh" src="@img1" />
                    <div class="overlay"><i class="fas fa-camera"></i></div>
                </div>
                <input type="file"
                       id="UploadHinhAnh"
                       name="UploadHinhAnh"
                       class="d-none"
                       onchange="previewImage(this, 'PreviewHinhAnh')" />
            </div>

            <!-- Cột phải -->
            <div>
                <div class="column-header">Đáp án và giải thích (mẹo)</div>
                <div class="img-picker" onclick="document.getElementById('UploadAnhMeo').click()">
                    @{
                        string img2 = string.IsNullOrEmpty(Model.UrlAnhMeo)
                        ? "/images/no-image.png"
                        : (Model.UrlAnhMeo.StartsWith("/") ? Model.UrlAnhMeo : "/" + Model.UrlAnhMeo);
                    }
                    <img id="PreviewAnhMeo" src="@img2" />
                    <div class="overlay"><i class="fas fa-camera"></i></div>
                </div>
                <input type="file"
                       id="UploadAnhMeo"
                       name="UploadAnhMeo"
                       class="d-none"
                       onchange="previewImage(this, 'PreviewAnhMeo')" />
            </div>
        </div>
    </div>

    <!-- ĐÁP ÁN -->
    <div class="qa-card">
        <h5 class="fw-bold mb-3 text-success">
            <i class="fa fa-list-check me-2"></i> Danh sách đáp án
        </h5>

        <table class="answers-table">
            <thead>
                <tr>
                    <th style="width: 20%;">Thứ tự</th>
                    <th>Đáp án đúng</th>
                </tr>
            </thead>
            <tbody>
                @for (int i = 0; i < Model.DapAns.Count; i++)
                {
                    <tr>
                        <td>@Model.DapAns[i].ThuTu</td>
                        <td>
                            <input type="checkbox"
                                   class="form-check-input answer-check"
                                   asp-for="DapAns[i].DapAnDung"
                                   data-index="@i" />

                            <span id="status_@i" class="answer-status" style="display: none;"></span>

                            <input type="hidden" asp-for="DapAns[i].IdDapAn" />
                            <input type="hidden" asp-for="DapAns[i].ThuTu" />
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    <!-- NÚT SAVE -->
    <button type="submit" class="btn btn-primary px-4">
        <i class="fa fa-save me-1"></i> Lưu thay đổi
    </button>

</form>

@section Scripts {
    <script>
        function previewImage(input, target) {
            if (input.files && input.files[0]) {
                let reader = new FileReader();
                reader.onload = e => document.getElementById(target).src = e.target.result;
                reader.readAsDataURL(input.files[0]);
            }
        }

        // CHỈ CHO PHÉP 1 ĐÁP ÁN ĐÚNG
        $(".answer-check").on("change", function () {
            if (this.checked) {
                $(".answer-check").not(this).prop("checked", false);
            }
            updateAllAnswerStatuses();
        });

        function updateAllAnswerStatuses() {
            $(".answer-check").each(function(index) {
                const statusSpan = $("#status_" + index);
                if ($(this).is(":checked")) {
                    statusSpan.removeClass("status-incorrect").addClass("status-correct");
                    statusSpan.text("✓ ĐÚNG").show();
                } else {
                    statusSpan.removeClass("status-correct").addClass("status-incorrect");
                    statusSpan.text("✕ Sai").show();
                }
            });
        }

        $(document).ready(function() {
            updateAllAnswerStatuses();
        });
    </script>
}