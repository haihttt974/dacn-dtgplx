@model dacn_dtgplx.ViewModels.AdminHoSoDetailVM
@{
    ViewData["Title"] = "Chi tiết hồ sơ";
    var hoSo = Model.HoSo;
}
@{
    var avatarPath = hoSo.User.Avatar ?? "";
    const string prefix = "wwwroot/";
    if (avatarPath.StartsWith(prefix, StringComparison.OrdinalIgnoreCase))
    {
        avatarPath = avatarPath.Substring(prefix.Length);
    }
    var avatarUrl = Url.Content("~/" + avatarPath.TrimStart('/'));

    var rawIdPhoto = hoSo.KhamSucKhoe ?? "";
    var cleanIdPhoto = rawIdPhoto.StartsWith("wwwroot", StringComparison.OrdinalIgnoreCase)
        ? rawIdPhoto.Substring("wwwroot".Length).TrimStart('/', '\\')
        : rawIdPhoto.TrimStart('/', '\\');

    var idPhotoUrl = Url.Content("~/" + cleanIdPhoto);
}
<div class="content-header mb-3">
    <h3><i class="fas fa-user"></i> Chi tiết hồ sơ: @hoSo.User.TenDayDu</h3>
</div>

<div class="card shadow-sm">
    <div class="card-body">

        <!-- Tabs -->
        <ul class="nav nav-tabs mb-4">
            <li class="nav-item">
                <a class="nav-link active" data-bs-toggle="tab" href="#info">Thông tin cá nhân</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-bs-toggle="tab" href="#hoso">Thông tin hồ sơ</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-bs-toggle="tab" href="#khoahoc">Khóa học</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-bs-toggle="tab" href="#suckhoe">Sức khỏe</a>
            </li>
        </ul>

        <div class="tab-content">

            <!-- TAB 1 -->
            <div class="tab-pane fade show active" id="info">
                <div class="row g-3">

                    <!-- Cột trái: avatar + tên -->
                    <div class="col-md-4">
                        <div class="card shadow-sm border-0 h-100">
                            <div class="card-body text-center">

                                <div class="mb-3">
                                    <img src="@avatarUrl"
                                         alt="Ảnh đại diện"
                                         class="img-fluid rounded-circle border"
                                         style="width:150px;height:150px;object-fit:cover;" />
                                </div>

                                <h5 class="fw-bold mb-1">
                                    @hoSo.User.TenDayDu
                                </h5>

                                <span class="badge bg-primary-subtle text-primary border rounded-pill px-3 py-1">
                                    <i class="fa-solid fa-id-card me-1"></i> @hoSo.User.Cccd
                                </span>

                            </div>
                        </div>
                    </div>

                    <!-- Cột phải: thông tin chi tiết -->
                    <div class="col-md-8">
                        <div class="card shadow-sm border-0 h-100">
                            <div class="card-body">

                                <h5 class="fw-semibold mb-3">
                                    <i class="fa-solid fa-circle-info me-2 text-primary"></i>
                                    Thông tin cá nhân
                                </h5>

                                <div class="row">
                                    <div class="col-sm-6 mb-3">
                                        <div class="small text-muted">Ngày sinh</div>
                                        <div>
                                            <i class="fa-regular fa-calendar-days me-1 text-secondary"></i>
                                            @hoSo.User.NgaySinh?.ToString("dd/MM/yyyy")
                                        </div>
                                    </div>

                                    <div class="col-sm-6 mb-3">
                                        <div class="small text-muted">Giới tính</div>
                                        <div>
                                            <i class="fa-solid fa-venus-mars me-1 text-secondary"></i>
                                            @hoSo.User.GioiTinh
                                        </div>
                                    </div>

                                    <div class="col-sm-6 mb-3">
                                        <div class="small text-muted">Điện thoại</div>
                                        <div>
                                            <i class="fa-solid fa-phone me-1 text-secondary"></i>
                                            @hoSo.User.SoDienThoai
                                        </div>
                                    </div>

                                    <div class="col-sm-6 mb-3">
                                        <div class="small text-muted">Email</div>
                                        <div>
                                            <i class="fa-solid fa-envelope me-1 text-secondary"></i>
                                            @hoSo.User.Email
                                        </div>
                                    </div>

                                    <div class="col-12 mb-2">
                                        <div class="small text-muted">Địa chỉ</div>
                                        <div>
                                            <i class="fa-solid fa-location-dot me-1 text-secondary"></i>
                                            @hoSo.User.DiaChi
                                        </div>
                                    </div>
                                </div>

                            </div>
                        </div>
                    </div>

                </div>
            </div>

            <!-- TAB 2: THÔNG TIN HỒ SƠ -->
            <div class="tab-pane fade" id="hoso">
                <div class="card shadow-sm border-0">
                    <div class="card-body">

                        <h5 class="fw-semibold mb-3">
                            <i class="fa-solid fa-file-lines me-2 text-primary"></i>
                            Thông tin hồ sơ đăng ký
                        </h5>

                        <div class="row g-4">
                            <!-- CỘT TRÁI: ẢNH THẺ -->
                            <div class="col-md-4 text-center">
                                <div class="border rounded-4 p-2 bg-light">
                                    <a href="@idPhotoUrl" target="_blank" title="Xem ảnh lớn">
                                        <img src="@idPhotoUrl"
                                             alt="Ảnh thẻ"
                                             class="img-fluid rounded-3"
                                             style="max-height:260px; object-fit:cover;" />
                                    </a>
                                </div>
                            </div>

                            <!-- CỘT PHẢI: THÔNG TIN HỒ SƠ -->
                            <div class="col-md-8">
                                <div class="row">
                                    <div class="col-sm-6 mb-3">
                                        <div class="small text-muted">Loại hồ sơ</div>
                                        <div class="fw-semibold">
                                            <i class="fa-solid fa-layer-group me-1 text-secondary"></i>
                                            @hoSo.LoaiHoSo
                                        </div>
                                    </div>

                                    <div class="col-sm-6 mb-3">
                                        <div class="small text-muted">Ngày đăng ký</div>
                                        <div>
                                            <i class="fa-regular fa-calendar-days me-1 text-secondary"></i>
                                            @hoSo.NgayDk?.ToString("dd/MM/yyyy")
                                        </div>
                                    </div>

                                    <div class="col-sm-6 mb-3">
                                        <div class="small text-muted">Trạng thái hồ sơ</div>
                                        <div>
                                            @if (hoSo.DaDuyet == null)
                                            {
                                                <span class="badge bg-warning text-dark">
                                                    <i class="fa-solid fa-hourglass-half me-1"></i> Chưa duyệt
                                                </span>
                                            }
                                            else if (hoSo.DaDuyet == true)
                                            {
                                                <span class="badge bg-success">
                                                    <i class="fa-solid fa-check me-1"></i> Đã duyệt
                                                </span>
                                            }
                                            else
                                            {
                                                <span class="badge bg-danger">
                                                    <i class="fa-solid fa-xmark me-1"></i> Từ chối
                                                </span>
                                            }
                                        </div>
                                    </div>

                                    <div class="col-12 mt-2">
                                        <div class="small text-muted">Ghi chú</div>
                                        <div class="border rounded p-2 bg-light-subtle">
                                            @(string.IsNullOrWhiteSpace(hoSo.GhiChu) ? "Không có ghi chú" : hoSo.GhiChu)
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>

            <!-- TAB 3 -->
            <div class="tab-pane fade" id="khoahoc">
                @foreach (var dk in hoSo.DangKyHocs)
                {
                    <div class="border rounded p-3 mb-3">
                        <h5 class="text-primary">@dk.KhoaHoc.TenKhoaHoc</h5>
                        <p><b>Bắt đầu:</b> @dk.KhoaHoc.NgayBatDau?.ToString("dd/MM/yyyy")</p>
                        <p><b>Kết thúc:</b> @dk.KhoaHoc.NgayKetThuc?.ToString("dd/MM/yyyy")</p>
                    </div>
                }
            </div>

            <!-- TAB 4: SỨC KHỎE -->
            <div class="tab-pane fade" id="suckhoe">
                <div class="card shadow-sm border-0">
                    <div class="card-body">

                        <h5 class="fw-semibold mb-3">
                            <i class="fas fa-heartbeat me-2 text-danger"></i>
                            Thông tin sức khỏe
                        </h5>

                        @if (Model.RawJson == null)
                        {
                            <div class="alert alert-warning mb-0">
                                Không thể giải mã dữ liệu sức khỏe từ ảnh thẻ.
                            </div>
                        }
                        else
                        {
                            var sk = Model.SucKhoe;

                            <!-- Thông tin sức khỏe dạng lưới -->
                            <div class="row g-3 mb-3 mt-1">
                                <div class="col-md-6">
                                    <div class="small text-muted">Thời hạn giấy khám</div>
                                    <div>
                                        <i class="fa-regular fa-calendar-days me-1 text-secondary"></i>
                                        @sk.ThoiHan
                                    </div>
                                </div>

                                <div class="col-md-6">
                                    <div class="small text-muted">Huyết áp</div>
                                    <div>
                                        <i class="fa-solid fa-stethoscope me-1 text-secondary"></i>
                                        @sk.HuyetAp120
                                    </div>
                                </div>

                                <div class="col-md-6">
                                    <div class="small text-muted">Chiều cao</div>
                                    <div>
                                        <i class="fa-solid fa-ruler-vertical me-1 text-secondary"></i>
                                        @sk.ChieuCaoCm cm
                                    </div>
                                </div>

                                <div class="col-md-6">
                                    <div class="small text-muted">Cân nặng</div>
                                    <div>
                                        <i class="fa-solid fa-weight-scale me-1 text-secondary"></i>
                                        @sk.CanNangKg kg
                                    </div>
                                </div>

                                <div class="col-md-6">
                                    <div class="small text-muted">Mắt trái (10/10)</div>
                                    <div>
                                        <i class="fa-regular fa-eye me-1 text-secondary"></i>
                                        @sk.Mat?.MatTrai10
                                    </div>
                                </div>

                                <div class="col-md-6">
                                    <div class="small text-muted">Mắt phải (10/10)</div>
                                    <div>
                                        <i class="fa-regular fa-eye me-1 text-secondary"></i>
                                        @sk.Mat?.MatPhai10
                                    </div>
                                </div>
                            </div>

                            <hr />

                            <!-- Ảnh giấy khám -->
                            <h5 class="fw-semibold mb-2">
                                <i class="fas fa-images me-2 text-primary"></i>
                                Ảnh giấy khám sức khỏe
                            </h5>

                            @if (Model.DanhSachAnhGiayKham == null || !Model.DanhSachAnhGiayKham.Any())
                            {
                                <div class="alert alert-info mb-0">
                                    Không có ảnh giấy khám nào được lưu.
                                </div>
                            }
                            else
                            {
                                <div class="d-flex flex-wrap gap-3 mt-2">
                                    @foreach (var img in Model.DanhSachAnhGiayKham)
                                    {
                                        var imgUrl = Url.Content("~/" + img.TrimStart('/'));
                                        <div class="shadow-sm border rounded-3 overflow-hidden"
                                             style="width:150px; height:180px; cursor:pointer;"
                                             onclick="zoom('@imgUrl')">
                                            <img src="@imgUrl"
                                                 class="w-100 h-100"
                                                 style="object-fit:cover;" />
                                        </div>
                                    }
                                </div>
                            }
                        }

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ZOOM MODAL -->
<div class="modal fade" id="zoomModal">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content bg-dark">
            <img id="zoomImg" class="img-fluid rounded" />
        </div>
    </div>
</div>

<script>
    function zoom(src) {
        document.getElementById("zoomImg").src = src;
        new bootstrap.Modal(document.getElementById("zoomModal")).show();
    }
</script>
