@model IEnumerable<dacn_dtgplx.Models.XeTapLai>

@{
    ViewData["Title"] = "Thuê Xe Tập Lái";
}

<link rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />

<style>
    :root {
        --green: #00A862;
        --green-dark: #01804b;
        --red: #ff4d4d;
    }

    .xe-card {
        border-radius: 14px;
        border: 1px solid #ddd;
        padding: 12px;
        height: 100%;
        display: flex;
        flex-direction: column;
        transition: 0.25s;
        background: #fff;
    }

        .xe-card:hover {
            transform: translateY(-4px);
            box-shadow: 0px 6px 22px rgba(0,0,0,0.12);
        }

    .xe-img {
        width: 100%;
        height: 180px;
        object-fit: contain;
        border-radius: 12px;
        background: #fff;
    }

    .btn-thue {
        background: var(--green);
        color: white;
        border-radius: 20px;
        padding: 8px 20px;
        font-weight: 600;
        text-align: center;
        display: inline-block;
        transition: 0.2s;
        text-decoration: none;
    }

        .btn-thue:hover {
            background: var(--green-dark);
            color: #fff;
            text-decoration: none;
        }

    /* ===========================
           FILTER BOX
           =========================== */

    .filter-box {
        background: white;
        padding: 25px;
        border-radius: 18px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        margin-bottom: 30px;
    }

    .filter-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 18px;
    }

    .form-control, .form-select {
        border-radius: 12px;
        padding: 10px 14px;
        border: 1.5px solid #dbdbdb;
    }

    .btn-filter {
        background: var(--green);
        color: white;
        border-radius: 12px;
        padding: 9px 24px;
        font-weight: 600;
    }

        .btn-filter:hover {
            background: var(--green-dark);
        }

    .btn-reset {
        border: 2px solid var(--red);
        color: var(--red);
        background: white;
        border-radius: 12px;
        padding: 9px 24px;
        font-weight: 600;
    }

        .btn-reset:hover {
            background: var(--red);
            color: white;
        }

    /* PRICE SLIDER (min / max) */
    .price-slider {
        position: relative;
        margin-top: 10px;
    }

    .bubble {
        font-size: 13px;
        font-weight: 600;
    }

    /* MODAL */
    .modal-left-box {
        background: #f9f9f9;
        border-radius: 12px;
        padding: 20px;
    }

    .modal-left-img {
        width: 100%;
        height: 160px;
        object-fit: contain;
        border-radius: 10px;
        background: #fff;
    }
</style>

<div class="container py-4">

    <h2 class="fw-bold text-center mb-4">Danh Sách Xe Tập Lái</h2>

    <!-- ================= FILTER ================= -->
    <div class="filter-box">

        <div class="filter-grid">
            <div>
                <label class="fw-bold mb-1">Tên xe</label>
                <input id="searchBox" class="form-control" placeholder="Nhập tên xe..." />
            </div>

            <div>
                <label class="fw-bold mb-1">Loại xe</label>
                <select id="typeSelect" class="form-select">
                    <option value="">Tất cả</option>
                    @foreach (var loai in ViewBag.LoaiXeList)
                    {
                        <option value="@loai">@loai</option>
                    }
                </select>
            </div>

            <div>
                <label class="fw-bold mb-1">Sắp xếp giá</label>
                <select id="sortSelect" class="form-select">
                    <option value="">Mặc định</option>
                    <option value="asc">Giá tăng dần</option>
                    <option value="desc">Giá giảm dần</option>
                </select>
            </div>
        </div>

        <div class="mt-3 row">
            <div class="col-md-6">
                <label class="fw-bold mb-1">Giá tối thiểu (đ)</label>
                <input type="number" id="minPrice" class="form-control" placeholder="0" />
            </div>
            <div class="col-md-6">
                <label class="fw-bold mb-1">Giá tối đa (đ)</label>
                <input type="number" id="maxPrice" class="form-control" placeholder="1.000.000" />
            </div>
        </div>

        <div class="d-flex justify-content-end gap-3 mt-4">
            <button class="btn-filter" onclick="loadData(1)">Lọc</button>
            <button class="btn-reset" onclick="resetFilter()">Xóa lọc</button>
        </div>
    </div>

    <!-- LIST -->
    <div id="xeContainer">
        @Html.Partial("_XeCards", Model)
    </div>
</div>

<!-- ======================= -->
<!-- MODAL THUÊ XE -->
<!-- ======================= -->

<div class="modal fade" id="rentModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">

            <div class="modal-header">
                <h5 class="modal-title fw-bold">Thuê xe tập lái</h5>
                <button class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                <div class="row">

                    <!-- INFO XE -->
                    <div class="col-md-5 modal-left-box">
                        <img id="m_xeImg" class="modal-left-img mb-3" />

                        <h5 class="fw-bold text-primary" id="m_xeLoai"></h5>
                        <p><strong>Biển số:</strong> <span id="m_xeBienSo"></span></p>
                        <p><strong>Giá thuê theo giờ:</strong> <span id="m_xeGia"></span> đ</p>
                    </div>

                    <!-- FORM THUÊ -->
                    <div class="col-md-7">
                        <input type="hidden" id="rentXeId" />

                        <h6 class="fw-bold mb-3">Thông tin người thuê</h6>

                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Họ tên *</label>
                                <input class="form-control" id="rentName" />
                            </div>

                            <div class="col-md-6">
                                <label class="form-label">Email *</label>
                                <input class="form-control"
                                       id="rentEmail"
                                       required
                                       type="email"
                                       placeholder="email@example.com" />
                            </div>

                            <div class="col-md-6">
                                <label class="form-label">Số điện thoại *</label>
                                <input class="form-control"
                                       id="rentPhone"
                                       required
                                       pattern="^0[1-9][0-9]{8}$"
                                       maxlength="10"
                                       inputmode="numeric"
                                       oninput="this.value=this.value.replace(/[^0-9]/g,'')"
                                       placeholder="0xxxxxxxxx"
                                       title="Số điện thoại phải đủ 10 số, bắt đầu bằng 0" />
                            </div>

                            <div class="col-md-6">
                                <label class="form-label">CCCD</label>
                                <input class="form-control" id="rentCCCD" />
                            </div>

                            <div class="col-md-6">
                                <label class="form-label">Ngày & giờ bắt đầu *</label>
                                <input type="datetime-local" class="form-control" id="rentDateTime" />
                            </div>

                            <div class="col-md-6">
                                <label class="form-label">Số giờ thuê (1–8h) *</label>
                                <input type="number" class="form-control" id="rentDuration" value="1" min="1" max="8" />
                            </div>

                            <div class="alert alert-success mt-3 mb-0">
                                Tổng tiền dự kiến: <b id="rentTotal">0</b> đ
                            </div>
                        </div>

                    </div>

                </div>
            </div>

            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button class="btn btn-outline-primary" id="btnCheckTime">
                    Kiểm tra lịch
                </button>
                <button class="btn btn-success" id="btnRentConfirm" disabled>
                    Xác nhận
                </button>
            </div>

        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // ========================
    // FILTER + PAGING
    // ========================
    function loadData(page) {
        $.get("/ThueXe/Filter", {
            page: page,
            search: $("#searchBox").val(),
            type: $("#typeSelect").val(),
            sort: $("#sortSelect").val(),
            min: $("#minPrice").val(),
            max: $("#maxPrice").val()
        }, function (html) {
            $("#xeContainer").html(html);
        });
    }

    function resetFilter() {
        $("#searchBox").val("");
        $("#typeSelect").val("");
        $("#sortSelect").val("");
        $("#minPrice").val("");
        $("#maxPrice").val("");
        loadData(1);
    }

    // ========================
    // MODAL + THUÊ XE
    // ========================
    let rentLocked = false;      // đã lock giờ sau khi check lịch chưa?
    let currentPrice = 0;        // giá / giờ hiện tại

    // Email cơ bản
    const emailRegex = /^[A-Za-z0-9._%+-]+@@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$/;

    // SĐT: 0 + (1–9) + 8 số = đủ 10 số
    const phoneRegex = /^0[1-9][0-9]{8}$/;

    const cccdRegex  = /^[0-9]{12}$/;

    function resetModalLock() {
        rentLocked = false;
        $("#rentDateTime, #rentDuration").prop("disabled", false);
        $("#btnRentConfirm").prop("disabled", true);
        $("#btnCheckTime")
            .removeClass("btn-danger")
            .addClass("btn-outline-primary")
            .text("Kiểm tra lịch");
    }

    // CLICK NÚT THUÊ TRONG CARD
    function thueXe(id) {
        $.get("/ThueXe/Thue/" + id, function (res) {
            if (!res.success) {
                alert(res.message);
                return;
            }

            $("#rentXeId").val(id);
            resetModalLock();

            // load thông tin xe
            $.get("/api/xetaplai/" + id, function (xe) {
                $("#m_xeImg").attr("src", xe.anhXe);
                $("#m_xeLoai").text(xe.loaiXe);
                $("#m_xeBienSo").text(xe.bienSo);
                $("#m_xeGia").text(xe.giaThueTheoGio.toLocaleString());
                currentPrice = xe.giaThueTheoGio;

                updateTotal();
            });

            // khách vãng lai -> clear
            if (res.requireLogin === false) {
                $("#rentName").val("");
                $("#rentEmail").val("");
                $("#rentPhone").val("");
                $("#rentCCCD").val("");
            }

            // user đăng nhập
            if (res.requireLogin === true) {
                $("#rentName").val(res.userInfo.ten);
                $("#rentEmail").val(res.userInfo.email);
                $("#rentPhone").val(res.userInfo.sdt);
                $("#rentCCCD").val(res.userInfo.cccd);
            }

            // default datetime = now (rounded to 5')
            const now = new Date();
            now.setMinutes(now.getMinutes() - (now.getMinutes() % 5));
            const iso = now.toISOString().slice(0, 16);
            $("#rentDateTime").val(iso);
            $("#rentDuration").val(1);

            updateTotal();

            $("#rentModal").modal("show");
        });
    }

    function updateTotal() {
        let hours = parseInt($("#rentDuration").val() || "1");
        if (hours < 1) hours = 1;
        if (hours > 8) hours = 8;
        $("#rentDuration").val(hours);
        let total = currentPrice * hours;
        $("#rentTotal").text(total.toLocaleString());
    }

    $("#rentDuration").on("input", function () {
        if (!rentLocked) {
            updateTotal();
        }
    });

    // ========================
    // KIỂM TRA LỊCH
    // ========================
    $("#btnCheckTime").on("click", function () {
        if (!rentLocked) {
            // đang mở -> gọi API check
            const start = $("#rentDateTime").val();
            const duration = parseInt($("#rentDuration").val() || "1");
            const xeId = $("#rentXeId").val();

            if (!start) {
                alert("Vui lòng chọn ngày & giờ bắt đầu.");
                return;
            }
            if (duration < 1 || duration > 8) {
                alert("Số giờ thuê phải từ 1 đến 8.");
                return;
            }

            $.get("/ThueXe/CheckTime", {
                xeId: xeId,
                rentStart: start,
                durationHours: duration
            }, function (res) {
                if (!res.success) {
                    alert(res.message);
                    return;
                }

                // OK -> lock giờ + mở nút xác nhận
                rentLocked = true;
                $("#rentDateTime, #rentDuration").prop("disabled", true);
                $("#btnRentConfirm").prop("disabled", false);
                $("#btnCheckTime")
                    .removeClass("btn-outline-primary")
                    .addClass("btn-danger")
                    .text("Đổi giờ");
                alert("Khung giờ hợp lệ, bạn có thể xác nhận thuê xe.");
            });

        } else {
            // đang lock -> unlock (cho phép đổi giờ)
            resetModalLock();
        }
    });

    function validateRentContact() {
        const email = $("#rentEmail").val().trim();
        const phone = $("#rentPhone").val().trim();
        const cccd  = $("#rentCCCD").val().trim();

        // EMAIL
        if (!email) {
            alert("Vui lòng nhập Email.");
            $("#rentEmail").focus();
            return false;
        }
        if (!emailRegex.test(email)) {
            alert("Email không đúng định dạng.");
            $("#rentEmail").focus();
            return false;
        }

        // SĐT
        if (!phone) {
            alert("Vui lòng nhập số điện thoại.");
            $("#rentPhone").focus();
            return false;
        }
        if (!phoneRegex.test(phone)) {
            alert("Số điện thoại phải đủ 10 số và bắt đầu bằng 0.");
            $("#rentPhone").focus();
            return false;
        }

        // CCCD
        if (!cccd) {
            alert("Vui lòng nhập CCCD.");
            $("#rentCCCD").focus();
            return false;
        }
        if (!cccdRegex.test(cccd)) {
            alert("CCCD phải đủ đúng 12 số.");
            $("#rentCCCD").focus();
            return false;
        }

        return true;
    }


    // ========================
    // SUBMIT / TIẾP TỤC
    // ========================
    $("#btnRentConfirm").on("click", function () {
        
        if (!validateRentContact()) {
            return;
        }

        const dto = {
            Ten: $("#rentName").val(),
            Email: $("#rentEmail").val(),
            SDT: $("#rentPhone").val(),
            CCCD: $("#rentCCCD").val(),
            XeId: $("#rentXeId").val(),
            RentStart: $("#rentDateTime").val(),
            Duration: $("#rentDuration").val()
        };

        if (!dto.Ten || !dto.Email || !dto.RentStart) {
            alert("Vui lòng nhập đầy đủ Họ tên, Email và thời gian bắt đầu.");
            return;
        }

        $.post("/ThueXe/LuuThongTinTam", dto, function (res) {
            if (res.success) {
                window.location.href = "/ThueXe/XacNhanThue?id=" + dto.XeId;
            }
        });
    });
</script>
