@model dacn_dtgplx.ViewModels.HoSoThiSinhCreateVM

@{
    ViewData["Title"] = "Thêm hồ sơ thí sinh";
    var defaultIdPhoto = Url.Content("~/images/avatar/default-id-photo.png");
    var mauGiayKham = Url.Content("~/resources/mau-kham-suc-khoe-lai-xe.doc");
}

<div class="container mt-4">


    <h2 class="fw-bold mb-4">
        <i class="fa-solid fa-file-circle-plus me-2"></i>
        Thêm Hồ Sơ Thí Sinh
    </h2>

    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger">@TempData["Error"]</div>
    }

    @if (TempData["Success"] != null)
    {
        <div class="alert alert-success">@TempData["Success"]</div>
    }

    <form asp-action="Create"
          method="post"
          enctype="multipart/form-data"
          class="shadow rounded-4 p-4 bg-white">

        @Html.AntiForgeryToken()

        <div class="row">

            <!-- Ảnh thẻ -->
            <div class="col-md-4 mb-4">

                <label class="form-label fw-semibold">Ảnh thẻ (4x6)</label>

                <div class="border rounded-4 bg-light shadow-sm p-2 mb-2 preview-frame">
                    <img id="previewAnhThe"
                         src="@defaultIdPhoto"
                         data-default="@defaultIdPhoto"
                         class="img-fluid rounded preview-img" />
                </div>

                <input asp-for="AnhThe"
                       type="file"
                       accept="image/*"
                       class="form-control"
                       id="AnhTheInput"
                       required />
                <span asp-validation-for="AnhThe" class="text-danger"></span>

                <p class="small text-muted mt-2">
                    • Ảnh thẻ nền <b>trắng hoặc xanh dương, phông trơn</b><br />
                    • Khuôn mặt ở <b>chính giữa khung hình</b>, không lệch sang hai bên<br />
                    • Đầu và vai <b>thẳng, không nghiêng</b><br />
                    • <b>Tóc không che mắt, trán và khuôn mặt</b><br />
                    • Ảnh <b>đủ sáng, không bị tối hoặc lóa</b><br />
                    • Ảnh <b>rõ nét, không bị mờ, nhòe</b><br />
                    • Mắt <b>mở, nhìn thẳng ống kính</b><br />
                    • Không đeo <b>kính màu</b>, không đội <b>mũ</b> hoặc phụ kiện che mặt<br />
                </p>

            </div>

            <!-- Ảnh giấy khám -->
            <div class="col-md-8 mb-4">

                <label asp-for="AnhGiayKham" class="form-label fw-semibold">
                    Ảnh giấy khám sức khỏe
                </label>

                <input asp-for="AnhGiayKham"
                       type="file"
                       accept="image/*"
                       multiple
                       class="form-control"
                       id="GiayKhamInput"
                       required />

                <div class="small text-muted mt-2">
                    • Có thể chọn nhiều ảnh<br />
                    • Chọn đúng thứ tự (1 → 2 → 3 …)<br />
                </div>

                <div class="mt-3">
                    <a href="@mauGiayKham"
                       download
                       class="btn btn-outline-primary btn-sm">
                        <i class="fa-solid fa-download me-2"></i>
                        Tải mẫu Giấy Khám Sức Khỏe mới nhất (2025)
                    </a>

                    <p class="small text-muted mt-1">
                        File định dạng <b>.doc</b> – có thể mở bằng Microsoft Word hoặc Google Docs.
                    </p>
                </div>

                <div id="previewGiayKhamWrapper"
                     class="mt-3 d-flex flex-wrap gap-3">
                </div>

            </div>

        </div>

        <hr class="my-4" />

        <!-- Chọn hạng -->
        <h4 class="fw-bold mb-3">
            <i class="fa-solid fa-layer-group me-2"></i>
            Loại Hồ Sơ
        </h4>

        <div class="mb-4">
            <select asp-for="IdHang" class="form-control form-select" required>
                <option value="">-- Chọn hạng GPLX --</option>
                @foreach (var hang in ViewBag.Hangs)
                {
                    <option value="@hang.IdHang">@hang.MaHang - @hang.TenDayDu</option>
                }
            </select>
            <span asp-validation-for="IdHang" class="text-danger"></span>
        </div>

        <!-- Thông tin sức khỏe -->
        <h4 class="fw-bold mb-3">
            <i class="fa-solid fa-heart-pulse me-2"></i>
            Thông Tin Giấy Khám Sức Khỏe
        </h4>

        <div class="row">

            <div class="col-md-6 mb-3">
                <label class="form-label">Mắt trái</label>
                <input asp-for="SucKhoe.mat.mat_trai"
                       type="text"
                       placeholder="VD: 8/10"
                       class="form-control" />
                <span asp-validation-for="SucKhoe.mat.mat_trai" class="text-danger"></span>
            </div>

            <div class="col-md-6 mb-3">
                <label class="form-label">Mắt phải</label>
                <input asp-for="SucKhoe.mat.mat_phai"
                       type="text"
                       placeholder="VD: 10/10"
                       class="form-control" />
                <span asp-validation-for="SucKhoe.mat.mat_phai" class="text-danger"></span>
            </div>


            <div class="col-md-6 mb-3">
                <label class="form-label">Huyết áp</label>
                <input asp-for="SucKhoe.huyet_ap"
                       placeholder="VD: 120/80"
                       class="form-control" />
                <span asp-validation-for="SucKhoe.huyet_ap" class="text-danger"></span>
            </div>


            <div class="col-md-6 mb-3">
                <label class="form-label">Chiều cao (cm)</label>
                <input asp-for="SucKhoe.chieu_cao"
                       type="number"
                       class="form-control"
                       required />
            </div>

            <div class="col-md-6 mb-3">
                <label class="form-label">Cân nặng (kg)</label>
                <input asp-for="SucKhoe.can_nang"
                       type="number"
                       class="form-control"
                       required />
            </div>

            <div class="col-md-6 mb-3">
                <label class="form-label">Ngày khám</label>
                <input asp-for="SucKhoe.thoi_han"
                       type="date"
                       class="form-control"
                       max="@DateTime.Today.ToString("yyyy-MM-dd")"
                       min="@DateTime.Today.AddMonths(-12).ToString("yyyy-MM-dd")" />
                <span asp-validation-for="SucKhoe.thoi_han" class="text-danger"></span>
            </div>

            <div class="col-md-6 mb-3">
                <label class="form-label">Ngày hết hạn</label>
                <input type="date"
                       id="NgayHetHan"
                       class="form-control"
                       readonly />
            </div>

        </div>

        <div class="mt-4 text-end">
            <button class="btn btn-primary btn-lg px-4">
                <i class="fa-solid fa-save me-2"></i> Lưu hồ sơ
            </button>
        </div>

    </form>

</div>

<!-- Modal phóng to ảnh giấy khám -->
<div class="modal fade" id="imageZoomModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content bg-dark border-0">
            <div class="modal-body p-0 text-center">
                <img id="zoomImage" class="img-fluid rounded" />
            </div>
        </div>
    </div>
</div>

<style>
    .preview-frame {
        width: 100%;
        height: 260px;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
    }

    .preview-img {
        max-height: 100%;
        object-fit: cover;
        transition: .25s;
    }

        .preview-img:hover {
            transform: scale(1.05);
        }
</style>

@section Scripts {
    <script>
        // ===== Preview ảnh thẻ =====
        const anhTheInput = document.getElementById("AnhTheInput");
        const previewAnhThe = document.getElementById("previewAnhThe");
        const defaultAnhThe = previewAnhThe.getAttribute("data-default");

        anhTheInput?.addEventListener("change", function (e) {
            const file = e.target.files?.[0];
            if (!file || !file.type.startsWith("image/")) {
                previewAnhThe.src = defaultAnhThe;
                return;
            }
            previewAnhThe.src = URL.createObjectURL(file);
        });

        // ===== Preview & zoom ảnh giấy khám =====
        const giayKhamInput = document.getElementById("GiayKhamInput");
        const wrapperGiayKham = document.getElementById("previewGiayKhamWrapper");

        function enableZoom() {
            wrapperGiayKham.querySelectorAll("img").forEach(img => {
                img.style.cursor = "zoom-in";
                img.onclick = () => {
                    document.getElementById("zoomImage").src = img.src;
                    new bootstrap.Modal(document.getElementById("imageZoomModal")).show();
                };
            });
        }

        giayKhamInput?.addEventListener("change", function (e) {
            const files = Array.from(e.target.files || []);
            wrapperGiayKham.innerHTML = "";

            files.forEach((file, idx) => {
                if (!file.type.startsWith("image/")) return;

                const box = document.createElement("div");
                box.className = "border bg-light rounded-3 shadow-sm position-relative";
                box.style.width = "140px";
                box.style.height = "180px";
                box.style.overflow = "hidden";

                const img = document.createElement("img");
                img.src = URL.createObjectURL(file);
                img.className = "w-100 h-100";
                img.style.objectFit = "cover";

                const badge = document.createElement("span");
                badge.className = "badge bg-primary position-absolute";
                badge.style.top = "6px";
                badge.style.left = "6px";
                badge.textContent = "#" + (idx + 1);

                box.appendChild(img);
                box.appendChild(badge);
                wrapperGiayKham.appendChild(box);
            });

            enableZoom();
        });

        // ===== Realtime validation =====
        const matRegex = /^(10|[1-9])\/10$/;
        const huyetApRegex = /^(9[0-9]|1[0-9]{2}|200)\/(6[0-9]|7[0-9]|8[0-9]|90)$/;

        function showError(input, message) {
            if (!input) return;
            let span = input.nextElementSibling;
            if (!span || !span.classList.contains("js-error")) {
                span = document.createElement("span");
                span.className = "text-danger js-error";
                input.after(span);
            }
            span.textContent = message;
        }

        function clearError(input) {
            let span = input?.nextElementSibling;
            if (span && span.classList.contains("js-error")) {
                span.remove();
            }
        }

        // Validate từng trường ngay khi nhập
        const matTraiInput = document.querySelector("[name='SucKhoe.mat.mat_trai']");
        const matPhaiInput = document.querySelector("[name='SucKhoe.mat.mat_phai']");
        const huyetApInput = document.querySelector("[name='SucKhoe.huyet_ap']");
        const ngayInput = document.querySelector("[name='SucKhoe.thoi_han']");

        matTraiInput?.addEventListener("input", () => {
            if (!matRegex.test(matTraiInput.value)) {
                showError(matTraiInput, "Thị lực phải theo định dạng X/10 (VD: 8/10)");
            } else clearError(matTraiInput);
        });

        matPhaiInput?.addEventListener("input", () => {
            if (!matRegex.test(matPhaiInput.value)) {
                showError(matPhaiInput, "Thị lực phải theo định dạng X/10 (VD: 10/10)");
            } else clearError(matPhaiInput);
        });

        huyetApInput?.addEventListener("input", () => {
            if (!huyetApRegex.test(huyetApInput.value)) {
                showError(huyetApInput, "Huyết áp không hợp lệ (VD: 120/80)");
            } else clearError(huyetApInput);
        });

                // ===== Tự động tính Ngày hết hạn =====
        const ngayHetHanInput = document.getElementById("NgayHetHan");

        ngayInput?.addEventListener("change", () => {
            const today = new Date();
            const selected = new Date(ngayInput.value);
            const minDate = new Date();
            minDate.setMonth(minDate.getMonth() - 12);

            if (!ngayInput.value) {
                showError(ngayInput, "Vui lòng chọn ngày khám");
                ngayHetHanInput.value = "";
            } else if (selected > today || selected < minDate) {
                showError(ngayInput, "Ngày khám phải trong vòng 12 tháng và không lớn hơn hôm nay");
                ngayHetHanInput.value = "";
            } else {
                clearError(ngayInput);
                // Tính Ngày hết hạn = Ngày khám + 12 tháng
                const hetHan = new Date(selected);
                hetHan.setFullYear(hetHan.getFullYear() + 1); // cộng 12 tháng
                const yyyy = hetHan.getFullYear();
                const mm = String(hetHan.getMonth() + 1).padStart(2, '0');
                const dd = String(hetHan.getDate()).padStart(2, '0');
                ngayHetHanInput.value = `${yyyy}-${mm}-${dd}`;
            }
        });


        // ===== Kiểm tra trước khi submit =====
        document.querySelector("form")?.addEventListener("submit", function (e) {
            let valid = true;

            [matTraiInput, matPhaiInput, huyetApInput, ngayInput].forEach(input => {
                if (!input) return;
                const event = new Event('input');
                input.dispatchEvent(event);
                if (input.nextElementSibling?.classList.contains("js-error")) valid = false;
            });

            if (!valid) e.preventDefault(); // 🚫 Ngăn submit nếu còn lỗi
        });
    </script>
}
