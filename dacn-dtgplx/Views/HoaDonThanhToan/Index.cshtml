@using Microsoft.AspNetCore.Html
@model dacn_dtgplx.ViewModels.PaymentHistoryVM

@{
    ViewData["Title"] = "Lịch sử thanh toán";
}

@functions {
    IHtmlContent DisplayDate(DateOnly? d)
    {
        return d.HasValue 
            ? new HtmlString(d.Value.ToString("dd/MM/yyyy")) 
            : new HtmlString("<span class='text-muted'>---</span>");
    }

    string GetLogo(string? method)
    {
        if (string.IsNullOrWhiteSpace(method)) return null;

        method = method.ToLower();
        if (method.Contains("momo")) return "/images/logo/momo-logo.png";
        if (method.Contains("vnpay")) return "/images/logo/vnpay-logo.png";
        if (method.Contains("paypal")) return "/images/logo/paypal-logo.png";
        return null;
    }

    string RenderStatus(bool? status)
    {
        if (status == true)
            return "<span class='badge bg-success'><i class=\"fa-solid fa-circle-check me-1\"></i>Thành công</span>";

        if (status == false)
            return "<span class='badge bg-danger'><i class=\"fa-solid fa-circle-xmark me-1\"></i>Thất bại</span>";

        return "<span class='badge bg-warning text-dark'><i class=\"fa-solid fa-clock me-1\"></i>Chưa thanh toán</span>";
    }
}

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />

<style>
    .section-title {
        font-size: 1.4rem;
        font-weight: 700;
        color: #0d6efd;
        margin-top: 40px;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .payment-table th {
        white-space: nowrap;
    }

    .payment-card {
        border-radius: 15px;
        overflow: hidden;
        border: none;
    }

    .pay-logo {
        height: 22px;
        width: auto;
        object-fit: contain;
        margin-right: 6px;
    }
</style>

<div class="container mt-4">

    <h2 class="fw-bold mb-4 text-primary">
        <i class="fa-solid fa-file-invoice-dollar me-2"></i>
        Lịch sử thanh toán của bạn
    </h2>

    <!-- ========================== -->
    <!-- 1) LỊCH SỬ KHÓA HỌC -->
    <!-- ========================== -->
    <div class="section-title">
        <i class="fa-solid fa-graduation-cap"></i> Lịch sử thanh toán khóa học
    </div>

    @if (!Model.PaymentsKhoaHoc.Any())
    {
        <div class="alert alert-info shadow-sm">
            <i class="fa-solid fa-circle-info me-2"></i>
            Bạn chưa có thanh toán khóa học nào.
        </div>
    }
    else
    {
        <div class="card payment-card shadow-sm mb-4">
            <div class="card-body p-0">
                <table class="table table-hover align-middle payment-table mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>Mã</th>
                            <th>Khóa học</th>
                            <th>Ngày thanh toán</th>
                            <th>Số tiền</th>
                            <th>Phương thức</th>
                            <th>Trạng thái</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var hd in Model.PaymentsKhoaHoc)
                        {
                            <tr>
                                <td class="fw-bold">@hd.IdThanhToan</td>

                                <td>
                                    @if (hd.IdDangKyNavigation?.KhoaHoc != null)
                                    {
                                        @hd.IdDangKyNavigation.KhoaHoc.TenKhoaHoc
                                    }
                                    else
                                    {
                                        <span class="text-muted">(Không xác định)</span>
                                    }
                                </td>

                                <td>
                                    @if (hd.NgayThanhToan.HasValue)
                                    {
                                        @hd.NgayThanhToan.Value.ToString("dd/MM/yyyy")
                                    }
                                    else
                                    {
                                        @Html.Raw("<span class='text-muted'>---</span>")
                                    }
                                </td>

                                <td class="fw-bold @(hd.TrangThai == true ? "text-success" : "text-danger")">
                                    @((hd.SoTien ?? 0).ToString("N0")) đ
                                </td>

                                <td>
                                    @{
                                        var logo = GetLogo(hd.PhuongThucThanhToan);
                                        var name = hd.PhuongThucThanhToan ?? "Không rõ";
                                    }
                                    @if (logo != null)
                                    {
                                        <img src="@logo" class="pay-logo" alt="logo"> <span>@name</span>
                                    }
                                    else { <span>@name</span> }
                                </td>

                                <td>@Html.Raw(RenderStatus(hd.TrangThai))</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    }

    <!-- ========================== -->
    <!-- 2) LỊCH SỬ THUÊ XE -->
    <!-- ========================== -->
    <div class="section-title">
        <i class="fa-solid fa-car-side"></i> Lịch sử thanh toán thuê xe
    </div>

    @if (!Model.PaymentsThueXe.Any())
    {
        <div class="alert alert-info shadow-sm">
            <i class="fa-solid fa-circle-info me-2"></i>
            Bạn chưa có thanh toán thuê xe nào.
        </div>
    }
    else
    {
        <div class="card payment-card shadow-sm mb-4">
            <div class="card-body p-0">
                <table class="table table-hover align-middle payment-table mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>Mã</th>
                            <th>Xe thuê</th>
                            <th>Ngày thanh toán</th>
                            <th>Số tiền</th>
                            <th>Phương thức</th>
                            <th>Trạng thái</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var hd in Model.PaymentsThueXe)
                        {
                            <tr>
                                <td class="fw-bold">@hd.IdThanhToan</td>

                                <td>
                                    @(hd.PhieuTx?.Xe != null
                                        ? $"{hd.PhieuTx.Xe.LoaiXe} - {hd.PhieuTx.Xe.BienSo}"
                                        : "<span class='text-muted'>(Không xác định)</span>")
                                </td>

                                <td>
                                    @(hd.NgayThanhToan?.ToString("dd/MM/yyyy") ?? "<span class='text-muted'>---</span>")
                                </td>

                                <td class="fw-bold @(hd.TrangThai == true ? "text-success" : "text-danger")">
                                    @((hd.SoTien ?? 0).ToString("N0")) đ
                                </td>

                                <td>
                                    @{
                                        var logo = GetLogo(hd.PhuongThucThanhToan);
                                        var name = hd.PhuongThucThanhToan ?? "Không rõ";
                                    }
                                    @if (logo != null)
                                    {
                                        <img src="@logo" class="pay-logo"> <span>@name</span>
                                    }
                                    else { <span>@name</span> }
                                </td>

                                <td>@Html.Raw(RenderStatus(hd.TrangThai))</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    }

</div>

<style>
    table tbody tr:hover {
        background: #f8f9fa;
    }
</style>
