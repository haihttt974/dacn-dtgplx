@using dacn_dtgplx.ViewModels
@model GuiThongBaoViewModel

<div class="card shadow-lg p-4 border-0">

    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="fw-bold text-primary m-0">
            <i class="fa fa-paper-plane"></i> Gửi Thông Báo
        </h3>

        <a asp-action="SentList" class="btn btn-outline-primary fw-bold px-3">
            <i class="fa fa-history"></i> Thông báo đã gửi
        </a>
    </div>

    <form asp-action="GuiThongBao" method="post">

        <!-- ===== FORM GỬI ===== -->
        <div class="p-3 mb-4 rounded border bg-light shadow-sm">

            <div class="mb-3">
                <label class="form-label fw-bold text-secondary">Tiêu đề</label>
                <input class="form-control shadow-sm" name="TieuDe" placeholder="Nhập tiêu đề..." required />
            </div>

            <div class="mb-3">
                <label class="form-label fw-bold text-secondary">Nội dung</label>
                <textarea class="form-control shadow-sm" rows="4" name="NoiDung" placeholder="Nhập nội dung thông báo..." required></textarea>
            </div>
        </div>

        <!-- ===== CHỌN ROLE ===== -->
        <div class="p-3 mb-4 rounded border bg-white shadow-sm">

            <label class="form-label fw-bold text-secondary">Gửi theo vai trò:</label>

            <div class="d-flex flex-wrap gap-3 mt-2">

                <!-- Tất cả -->
                <div class="form-check me-3">
                    <input class="form-check-input role-checkbox" type="checkbox" value="0" id="roleAll" />
                    <label class="form-check-label fw-bold text-primary" for="roleAll">
                        <i class="fa fa-users"></i> Tất cả
                    </label>
                </div>

                @foreach (var r in Model.Roles)
                {
                    <div class="form-check">
                        <input class="form-check-input role-checkbox shadow-sm"
                               type="checkbox"
                               name="SelectedRoleIds"
                               value="@r.RoleId"
                               id="role_@r.RoleId" />

                        <label class="form-check-label" for="role_@r.RoleId">
                            <i class="fa fa-user-tag text-muted"></i> @r.RoleName
                        </label>
                    </div>
                }
            </div>
        </div>

        <!-- ===== CHỌN NGƯỜI NHẬN ===== -->
        <div class="p-3 rounded border bg-white shadow-sm">

            <label class="form-label fw-bold text-secondary">Chọn người nhận:</label>

            <!-- Bộ lọc -->
            <div class="mb-3">
                <input type="text" id="userSearch" class="form-control shadow-sm"
                       placeholder="Tìm kiếm người nhận theo tên / email / SĐT / role...">
            </div>

            <div class="table-responsive border rounded" style="max-height: 350px; overflow-y: auto;">
                <table class="table table-hover align-middle mb-0">
                    <thead class="table-dark text-center">
                        <tr>
                            <th style="width: 50px;"></th>
                            <th>Họ tên</th>
                            <th>Email</th>
                            <th>SĐT</th>
                            <th>Role</th>
                        </tr>
                    </thead>

                    <tbody id="userTable">
                        @foreach (var u in Model.Users)
                        {
                            <tr data-role="@u.RoleId" class="selectable-row text-center" style="cursor: pointer;">
                                <td>
                                    <input type="checkbox" class="user-checkbox shadow-sm"
                                           name="SelectedUserIds"
                                           value="@u.UserId" />
                                </td>
                                <td class="text-start">@u.FullName</td>
                                <td>@u.Email</td>
                                <td>@u.Phone</td>
                                <td>@Model.Roles.FirstOrDefault(r => r.RoleId == u.RoleId)?.RoleName</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>

            <button class="btn btn-primary px-4 mt-4 shadow-sm fw-bold" type="submit">
                <i class="fa fa-paper-plane"></i> Gửi thông báo
            </button>
        </div>

    </form>

</div>


<!-- =============================== -->
<!-- ======= JavaScript Logic ======= -->
<!-- =============================== -->
<script>
    const roleAll = document.getElementById("roleAll");
    const roleCheckboxes = document.querySelectorAll(".role-checkbox:not(#roleAll)");
    const userCheckboxes = document.querySelectorAll(".user-checkbox");

    // ====== TÌM KIẾM USER ======
    document.getElementById("userSearch").addEventListener("keyup", function () {
        const keyword = this.value.toLowerCase();
        document.querySelectorAll("#userTable tr").forEach(row => {
            const text = row.innerText.toLowerCase();
            row.style.display = text.includes(keyword) ? "" : "none";
        });
    });

    // ====== CLICK DÒNG USER ĐỂ CHỌN ======
    document.querySelectorAll(".selectable-row").forEach(row => {
        row.addEventListener("click", function (e) {

            // Nếu click vào checkbox → không double toggle
            if (e.target.type === "checkbox") return;

            const cb = this.querySelector(".user-checkbox");
            cb.checked = !cb.checked;

            cb.dispatchEvent(new Event("change"));
        });
    });

    // ====== Thay đổi TẤT CẢ ======
    roleAll.addEventListener("change", function () {
        const isChecked = this.checked;

        if (isChecked) {
            userCheckboxes.forEach(u => u.checked = true);
        } else {
            userCheckboxes.forEach(u => u.checked = false);

            roleCheckboxes.forEach(roleCb => {
                if (roleCb.checked) {
                    const roleId = roleCb.value;
                    document.querySelectorAll(`#userTable tr[data-role='${roleId}'] .user-checkbox`)
                        .forEach(cb => cb.checked = true);
                }
            });
        }
    });

    // ====== Thay đổi ROLE riêng lẻ ======
    roleCheckboxes.forEach(roleCb => {
        roleCb.addEventListener("change", function () {
            if (roleAll.checked) return;

            const roleId = this.value;
            document.querySelectorAll(`#userTable tr[data-role='${roleId}'] .user-checkbox`)
                .forEach(cb => cb.checked = this.checked);
        });
    });

    // ====== Thay đổi USER ======
    userCheckboxes.forEach(cb => {
        cb.addEventListener("change", function () {
            const row = cb.closest("tr");
            const roleId = row.dataset.role;

            if (roleId) {
                const usersInRole = document.querySelectorAll(`#userTable tr[data-role='${roleId}'] .user-checkbox`);
                const allInRoleChecked = Array.from(usersInRole).every(x => x.checked);

                const roleCb = document.getElementById("role_" + roleId);
                if (roleCb) {
                    roleCb.checked = allInRoleChecked;
                }
            }

            const allUsersChecked = Array.from(userCheckboxes).every(x => x.checked);
            roleAll.checked = allUsersChecked;
        });
    });
</script>


<style>
    .form-check-input {
        cursor: pointer;
    }

    table tbody tr:hover {
        background-color: #f5f8ff !important;
    }

    .table-dark th {
        background-color: #293241 !important;
        color: #fff;
        font-weight: 600;
    }

    .card {
        border-radius: 12px;
    }
</style>
